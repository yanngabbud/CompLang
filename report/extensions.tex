As the comments are not well integrated a good thing would be to change the code formatter to work at the tokens level. At this level there is a lot more of information and every kind of comment, even the most unlikely, could be correctly printed. Moreover at this level it could be possible to take into account the whitespace or the new lines that the user inserted.

Finally a cool feature would be to allow the user to give its own rules directly and that the code formatter takes it into account to format the code. For instance the rules could be stored inside a file and given as command line argument.